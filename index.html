<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RCI - Reporte T√©cnico de Servicios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f1f5f9;
    }
    .header {
      background-color: #1e40af;
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: 10px 10px 0 0;
    }
    .footer {
      background-color: #1e3a8a;
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: 40px;
      border-radius: 0 0 10px 10px;
    }
    .section-title {
      border-left: 4px solid #1d4ed8;
      padding-left: 12px;
      margin-bottom: 20px;
      font-weight: bold;
      font-size: 1.2rem;
      color: #1e3a8a;
    }
    .input-group {
      margin-bottom: 12px; /* Reducido para mayor compacidad */
    }
    label {
      font-weight: 600;
      color: #1e3a8a;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px; /* Reducido para mayor compacidad */
      border: 1px solid #cbd5e1;
      border-radius: 6px; /* Reducido para mayor compacidad */
      background-color: white;
    }
    input[type="checkbox"],
    input[type="radio"] {
        transform: scale(1.1); /* Ligeramente m√°s peque√±o para compacidad */
        margin-right: 6px; /* Reducido */
    }
    .btn {
      padding: 10px 20px; /* Reducido para mayor compacidad */
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 6px; /* Reducido */
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .btn:hover {
      background-color: #1d4ed8;
    }
    .btn-clear-signature {
        background-color: #ef4444;
        margin-top: 6px; /* Reducido */
        font-size: 0.85em; /* Ligeramente m√°s peque√±o */
        padding: 6px 12px; /* Reducido */
    }
    .btn-clear-signature:hover {
        background-color: #dc2626;
    }
    /* Estilo para el canvas de firma */
    canvas {
        border:1px solid #ccc;
        border-radius:6px; /* Reducido */
        background-color: #f9fafb;
        touch-action: none;
        margin-top: 8px; /* Espacio para separar del input de nombre */
    }
    /* Clase para ocultar elementos que no deben aparecer en el PDF */
    .pdf-hidden {
        display: none !important;
    }
    /* Estilos para el texto de los inputs en el PDF */
    .pdf-text-display {
        display: block !important;
        padding: 8px; /* Ajustado para consistencia */
        border: 1px solid #cbd5e1;
        border-radius: 6px; /* Ajustado para consistencia */
        background-color: white;
        color: #111827;
        font-family: 'Segoe UI', sans-serif;
        font-size: 1em;
        font-weight: normal;
        min-height: 38px; /* Ajustado para compacidad */
        box-sizing: border-box;
    }
    /* Estilo para las fotos en el PDF */
    .pdf-photo-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px; /* Reducido */
        margin-bottom: 16px; /* Reducido */
    }
    .pdf-photo-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .pdf-photo-item img {
        width: 100%;
        height: auto;
        max-height: 100px; /* Reducido ligeramente para m√°s compacidad */
        object-fit: contain;
        border: 1px solid #eee;
        border-radius: 6px; /* Reducido */
    }
    .pdf-photo-item span {
        font-size: 0.75em; /* M√°s peque√±o */
        color: #555;
        margin-top: 3px; /* Reducido */
    }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto mt-6 shadow-xl bg-white rounded-xl overflow-hidden" id="reporteContent">

    <!-- üß¢ Encabezado institucional -->
    <div class="header" id="headerSection">
      <h1 class="text-3xl font-bold">RCI Sistemas Contra Incendio</h1>
    </div>

    <div class="px-6 py-4">
      <!-- üîß DATOS GENERALES + UBICACI√ìN -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6" id="generalDataSection">
        <div>
          <label for="lugar">üìç Lugar</label>
          <div class="flex gap-2 mt-1">
            <input type="text" id="lugar" class="border rounded px-3 py-2 w-full" placeholder="Ubicaci√≥n" inputmode="text">
            <button onclick="obtenerUbicacion()" class="btn">Ubicaci√≥n GPS</button>
          </div>
        </div>
        <div>
          <label for="fecha">üìÖ Fecha</label>
          <input type="date" id="fecha" class="border rounded px-3 py-2 w-full mt-1">
        </div>
      </div>

      <div id="seccionBombas">
        <!-- üßØ BOMBA JOCKEY -->
        <div class="section-title">Bomba Jockey</div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="input-group"><label>V. Entrada L1-L2</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>V. Entrada L1-L3</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>V. Entrada L2-L3</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Amperaje L1</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Amperaje L2</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Amperaje L3</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Descarga PSI</label><input type="number" inputmode="numeric"></div>
        </div>

        <!-- ‚ö° BOMBA EL√âCTRICA -->
        <div class="section-title mt-8">Bomba El√©ctrica</div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="input-group"><label>V. Entrada L1-L2</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>V. Entrada L1-L3</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>V. Entrada L2-L3</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Amperaje L1</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Amperaje L2</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Amperaje L3</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Descarga PSI</label><input type="number" inputmode="numeric"></div>
        </div>

        <!-- üî• BOMBA DI√âSEL -->
        <div class="section-title mt-8">Bomba Di√©sel</div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="input-group">
            <label>Nivel Agua</label>
            <div class="flex items-center mt-1">
                <input type="text" inputmode="text" placeholder="Estado del nivel de agua">
                <input type="checkbox" class="ml-2 nivel-check"> <label class="text-sm font-normal">OK</label>
            </div>
          </div>
          <div class="input-group">
            <label>Nivel Aceite</label>
            <div class="flex items-center mt-1">
                <input type="text" inputmode="text" placeholder="Estado del nivel de aceite">
                <input type="checkbox" class="ml-2 nivel-check"> <label class="text-sm font-normal">OK</label>
            </div>
          </div>
          <div class="input-group">
            <label>Nivel Diesel</label>
            <div class="flex items-center mt-1">
                <input type="radio" name="nivelDiesel" value="+3/4" id="dieselPlus3_4" class="ml-2"> <label for="dieselPlus3_4" class="text-sm font-normal">+3/4</label>
                <input type="radio" name="nivelDiesel" value="-3/4" id="dieselMinus3_4" class="ml-2"> <label for="dieselMinus3_4" class="text-sm font-normal">-3/4</label>
            </div>
          </div>
          <div class="input-group">
            <label>Faltante de Litros (Diesel)</label>
            <input type="number" inputmode="numeric" placeholder="Litros faltantes">
          </div>
          <div class="input-group"><label>Presi√≥n Aceite PSI</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Temperatura Inicial ¬∞C</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Temperatura Final ¬∞C</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Horas Inicial</label><input type="number" inputmode="numeric"></div>
          <div class="input-group"><label>Horas Final</label><input type="number" inputmode="numeric"></div>
        </div>
      </div><!-- /#seccionBombas -->

      <!-- üíß INSPECCI√ìN DE HIDRANTES -->
      <div id="seccionHidrantes">
        <div class="section-title mt-10">Inspecci√≥n de Hidrantes</div>
        <div id="hidrantes-container">
          <!-- Los hidrantes se a√±adir√°n aqu√≠ din√°micamente -->
        </div>
        <!-- Bot√≥n para agregar hidrante -->
        <button onclick="agregarHidrante()" class="btn w-full sm:w-auto mt-4">Agregar Otro Hidrante</button>
      </div><!-- /#seccionHidrantes -->

      <!-- üì∏ EVIDENCIA FOTOGR√ÅFICA -->
      <div id="seccionFotos">
        <div class="section-title mt-10">Evidencia Fotogr√°fica</div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="photo-upload-container">
          <!-- Las fotos se a√±adir√°n aqu√≠ -->
          <div class="input-group">
              <label>Foto 1</label>
              <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full" data-photo-id="1">
              <input type="text" class="photo-location border rounded px-3 py-2 w-full mt-2" placeholder="Ubicaci√≥n de la Foto 1">
              <img class="photo-preview mt-2 w-full h-32 object-cover hidden" src="" alt="Previsualizaci√≥n de Foto 1">
          </div>
          <div class="input-group">
              <label>Foto 2</label>
              <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full" data-photo-id="2">
              <input type="text" class="photo-location border rounded px-3 py-2 w-full mt-2" placeholder="Ubicaci√≥n de la Foto 2">
              <img class="photo-preview mt-2 w-full h-32 object-cover hidden" src="" alt="Previsualizaci√≥n de Foto 2">
          </div>
          <div class="input-group">
              <label>Foto 3</label>
              <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full" data-photo-id="3">
              <input type="text" class="photo-location border rounded px-3 py-2 w-full mt-2" placeholder="Ubicaci√≥n de la Foto 3">
              <img class="photo-preview mt-2 w-full h-32 object-cover hidden" src="" alt="Previsualizaci√≥n de Foto 3">
          </div>
          <div class="input-group">
              <label>Foto 4</label>
              <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full" data-photo-id="4">
              <input type="text" class="photo-location border rounded px-3 py-2 w-full mt-2" placeholder="Ubicaci√≥n de la Foto 4">
              <img class="photo-preview mt-2 w-full h-32 object-cover hidden" src="" alt="Previsualizaci√≥n de Foto 4">
          </div>
          <div class="input-group">
              <label>Foto 5</label>
              <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full" data-photo-id="5">
              <input type="text" class="photo-location border rounded px-3 py-2 w-full mt-2" placeholder="Ubicaci√≥n de la Foto 5">
              <img class="photo-preview mt-2 w-full h-32 object-cover hidden" src="" alt="Previsualizaci√≥n de Foto 5">
          </div>
          <div class="input-group">
              <label>Foto 6</label>
              <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full" data-photo-id="6">
              <input type="text" class="photo-location border rounded px-3 py-2 w-full mt-2" placeholder="Ubicaci√≥n de la Foto 6">
              <img class="photo-preview mt-2 w-full h-32 object-cover hidden" src="" alt="Previsualizaci√≥n de Foto 6">
          </div>
        </div>
      </div><!-- /#seccionFotos -->

      <!-- ‚úçÔ∏è FIRMAS -->
      <div id="seccionFirmas">
        <div class="section-title mt-10">Firmas</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">

          <div class="flex flex-col items-center"> <!-- Contenedor flex para centrar -->
            <label for="tecnico">üë∑ T√©cnico</label>
            <input type="text" id="tecnico" class="border rounded px-3 py-2 w-full mt-1" placeholder="Nombre del T√©cnico">
            <canvas id="firmaTecnico" width="300" height="150" class="mt-2"></canvas>
            <button class="btn btn-clear-signature">Limpiar</button>
            <div id="displayNombreTecnico" class="text-center mt-2 font-semibold text-lg"></div>
          </div>

          <div class="flex flex-col items-center"> <!-- Contenedor flex para centrar -->
            <label for="atiende">üë§ Atiende</label>
            <input type="text" id="atiende" class="border rounded px-3 py-2 w-full mt-1" placeholder="Responsable en sitio">
            <canvas id="firmaSupervisor" width="300" height="150" class="mt-2"></canvas>
            <button class="btn btn-clear-signature">Limpiar</button>
            <div id="displayNombreSupervisor" class="text-center mt-2 font-semibold text-lg"></div>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-center">
            <input type="checkbox" id="autoFillNames" checked class="mr-2">
            <label for="autoFillNames" class="font-semibold text-blue-800">Se queda todo en autom√°tico</label>
        </div>
      </div><!-- /#seccionFirmas -->

      <!-- üìã OBSERVACIONES -->
      <div id="seccionObservaciones">
        <div class="section-title mt-10">Observaciones</div>
        <textarea id="observaciones" class="w-full h-24 p-3 border rounded mb-4" placeholder="Observaciones generales..."></textarea>
      </div><!-- /#seccionObservaciones -->

      <!-- BOTONES -->
      <div class="flex flex-col sm:flex-row gap-4 mt-4">
        <button id="pdfBtn" class="btn w-full sm:w-auto">Exportar a PDF</button>
        <button id="mailBtn" class="btn w-full sm:w-auto bg-green-600 hover:bg-green-700">Enviar por correo</button>
        <button id="whatsappBtn" class="btn w-full sm:w-auto bg-blue-600 hover:bg-blue-700">Compartir por WhatsApp</button>
      </div>
    </div> <!-- Cierre del cuerpo del reporte -->
    <!-- üß† Scripts funcionales -->
    <script>
      const { jsPDF } = window.jspdf;
      let hidranteCount = 0; // Contador para hidrantes

      // Funci√≥n para actualizar los nombres mostrados bajo las firmas
      function updateDisplayedNames() {
          const autoFillCheckbox = document.getElementById('autoFillNames');
          const tecnicoInput = document.getElementById('tecnico');
          const atiendeInput = document.getElementById('atiende');
          const displayTecnico = document.getElementById('displayNombreTecnico');
          const displaySupervisor = document.getElementById('displayNombreSupervisor');

          if (autoFillCheckbox.checked) {
              displayTecnico.textContent = tecnicoInput.value || '';
              displaySupervisor.textContent = atiendeInput.value || '';
          } else {
              displayTecnico.textContent = '';
              displaySupervisor.textContent = '';
          }
      }

      document.addEventListener('DOMContentLoaded', () => {
          agregarHidrante(); // A√±adir el primer hidrante al cargar la p√°gina

          // Inicializar los nombres mostrados
          updateDisplayedNames();

          // Escuchar cambios en los campos de T√©cnico y Atiende para actualizar los nombres mostrados
          document.getElementById('tecnico').addEventListener('input', updateDisplayedNames);
          document.getElementById('atiende').addEventListener('input', updateDisplayedNames);
          // Escuchar cambios en el checkbox "Se queda todo en autom√°tico"
          document.getElementById('autoFillNames').addEventListener('change', updateDisplayedNames);

          // Previsualizaci√≥n de im√°genes
          document.querySelectorAll('input[type="file"]').forEach(input => {
              input.addEventListener('change', function(event) {
                  const file = event.target.files[0];
                  if (file) {
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          const imgPreview = this.closest('.input-group').querySelector('.photo-preview');
                          if (imgPreview) {
                              imgPreview.src = e.target.result;
                              imgPreview.classList.remove('hidden');
                          }
                      }.bind(this);
                      reader.readAsDataURL(file);
                  } else {
                      const imgPreview = this.closest('.input-group').querySelector('.photo-preview');
                      if (imgPreview) {
                          imgPreview.src = '';
                          imgPreview.classList.add('hidden');
                      }
                  }
              });
          });

          // Asignar eventos de limpieza a los botones "Limpiar" de firma
          document.querySelectorAll('.btn-clear-signature').forEach(button => {
              button.addEventListener('click', function() {
                  const canvas = this.previousElementSibling;
                  if (canvas && canvas.tagName === 'CANVAS') {
                      clearSignature(canvas.id);
                  }
              });
          });
      });

      // Funci√≥n para inicializar canvas de firma
      function inicializarCanvasFirma(idCanvas) {
        const canvas = document.getElementById(idCanvas);
        const ctx = canvas.getContext("2d");
        let dibujando = false;

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        canvas.addEventListener("mousedown", (e) => {
          dibujando = true;
          const rect = canvas.getBoundingClientRect();
          ctx.beginPath();
          ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });
        canvas.addEventListener("mouseup", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("mouseout", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("mousemove", e => {
          if (!dibujando) return;
          const rect = canvas.getBoundingClientRect();
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.strokeStyle = "#111827";
          ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
          ctx.stroke();
        });

        canvas.addEventListener("touchstart", (e) => {
          dibujando = true;
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.beginPath();
          ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });
        canvas.addEventListener("touchend", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("touchcancel", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("touchmove", (e) => {
          if (!dibujando) return;
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.strokeStyle = "#111827";
          ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          ctx.stroke();
        });
      }

      function clearSignature(idCanvas) {
        const canvas = document.getElementById(idCanvas);
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      inicializarCanvasFirma("firmaTecnico");
      inicializarCanvasFirma("firmaSupervisor");

      // Convertir coordenadas a ubicaci√≥n y obtener ubicaci√≥n GPS
      async function obtenerUbicacion() {
        document.getElementById("lugar").value = "Obteniendo ubicaci√≥n...";
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async pos => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              const lugarInput = document.getElementById("lugar");

              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();

                if (data.display_name) {
                  lugarInput.value = data.display_name;
                  console.log("Ubicaci√≥n obtenida:", data.display_name);
                } else {
                  lugarInput.value = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
                  console.warn("No se encontr√≥ nombre de ubicaci√≥n para las coordenadas.");
                }
              } catch (error) {
                console.error("Error al obtener nombre de ubicaci√≥n:", error);
                lugarInput.value = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
                alert("No se pudo obtener el nombre de la ubicaci√≥n, mostrando coordenadas.");
              }
            },
            err => {
              console.error("Error al obtener ubicaci√≥n GPS:", err);
              alert("No se pudo obtener la ubicaci√≥n. Activa permisos de GPS y aseg√∫rate de tener conexi√≥n.");
              document.getElementById("lugar").value = "Ubicaci√≥n no disponible";
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        } else {
          alert("Tu navegador no permite geolocalizaci√≥n.");
          document.getElementById("lugar").value = "Geolocalizaci√≥n no soportada";
        }
      }

      // Funcionalidad para a√±adir hidrantes din√°micamente
      function agregarHidrante() {
        hidranteCount++;
        const container = document.getElementById('hidrantes-container');
        const newHidranteDiv = document.createElement('div');
        newHidranteDiv.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 hidrante-item';
        newHidranteDiv.innerHTML = `
          <div class="input-group">
            <label>Hidrante N¬∞ ${hidranteCount}</label>
            <div class="flex items-center mt-1">
                <input type="checkbox" class="ml-2 hidrante-check"> <label class="text-sm font-normal">OK</label>
            </div>
          </div>
          <div class="input-group">
            <label>Comentarios Hidrante N¬∞ ${hidranteCount}</label>
            <textarea class="w-full h-24 p-3 border rounded" placeholder="Comentarios sobre el hidrante..."></textarea>
          </div>
        `;
        container.appendChild(newHidranteDiv);
      }

      // Helper para preparar un elemento para la captura (reemplazar inputs con texto, etc.)
      function prepareElementForCapture(originalElement) {
          const clonedElement = originalElement.cloneNode(true);

          // Ocultar botones y elementos que no deben ir en el PDF
          clonedElement.querySelectorAll('.btn, input[type="file"], .btn-clear-signature').forEach(el => el.remove());

          // Reemplazar input/textarea con span que contenga el valor y aplicar estilos para PDF
          clonedElement.querySelectorAll('input:not([type="file"]):not([type="checkbox"]):not([type="radio"]), textarea').forEach(input => {
              const span = document.createElement('span');
              span.textContent = input.value || '';
              span.className = 'pdf-text-display'; // Aplicar estilos para el PDF
              input.parentNode.replaceChild(span, input);
          });

          // Manejar checkboxes y radio buttons: mostrar su estado como texto
          clonedElement.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
              const span = document.createElement('span');
              if (input.type === 'checkbox') {
                  // Espec√≠ficamente para el checkbox de autoFillNames
                  if (input.id === 'autoFillNames') {
                      span.textContent = `Se queda todo en autom√°tico: ${input.checked ? '[X] S√≠' : '[ ] No'}`;
                      span.className = 'font-semibold text-blue-800'; // Mantener estilo
                      // Eliminar el label asociado si existe
                      const associatedLabel = clonedElement.querySelector(`label[for="${input.id}"]`);
                      if (associatedLabel) associatedLabel.remove();
                  } else {
                      span.textContent = input.checked ? ' [X] OK' : ' [ ] NO OK';
                  }
              } else if (input.type === 'radio') {
                  if (input.checked) {
                      span.textContent = ` [X] ${input.value}`;
                  } else {
                      span.textContent = '';
                  }
              }
              span.style.marginLeft = '8px';
              span.style.fontWeight = 'normal';
              span.style.color = '#111827';
              // Reemplazar el input radio/checkbox y su label asociado (si no es autoFillNames)
              if (input.id !== 'autoFillNames' && input.nextElementSibling && input.nextElementSibling.tagName === 'LABEL') {
                  input.nextElementSibling.remove();
              }
              input.parentNode.replaceChild(span, input);
          });

          // Para los canvas de firma, dibujar el contenido del original en el clon
          clonedElement.querySelectorAll('canvas').forEach(clonedCanvas => {
              const originalCanvas = document.getElementById(clonedCanvas.id);
              if (originalCanvas) {
                  const ctx = clonedCanvas.getContext('2d');
                  ctx.drawImage(originalCanvas, 0, 0);
                  // Asegurar fondo blanco para la captura
                  ctx.globalCompositeOperation = 'destination-over';
                  ctx.fillStyle = '#ffffff';
                  ctx.fillRect(0, 0, clonedCanvas.width, clonedCanvas.height);
                  ctx.globalCompositeOperation = 'source-over';
              }
          });

          return clonedElement;
      }

      // Exportar PDF
      document.getElementById("pdfBtn").addEventListener("click", async () => {
        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 10; // Margen de 10mm en cada lado
        const contentWidth = pageWidth - 2 * margin;

        // Asegurarse de que el body tenga un fondo blanco para la captura
        document.body.style.backgroundColor = '#ffffff';

        let yOffset = margin;

        try {
            // 1. Secci√≥n de Encabezado y Datos Generales
            const headerAndGeneralData = document.createElement('div');
            headerAndGeneralData.appendChild(document.getElementById('headerSection').cloneNode(true));
            const generalDataSectionClone = document.getElementById('generalDataSection').cloneNode(true);
            headerAndGeneralData.appendChild(generalDataSectionClone);

            const preparedHeaderAndGeneralData = prepareElementForCapture(headerAndGeneralData);
            document.body.appendChild(preparedHeaderAndGeneralData);

            const canvasHeaderGeneral = await html2canvas(preparedHeaderAndGeneralData, { scale: 2, useCORS: true, allowTaint: true, logging: false });
            document.body.removeChild(preparedHeaderAndGeneralData);

            const imgDataHeaderGeneral = canvasHeaderGeneral.toDataURL('image/png');
            const imgPropsHeaderGeneral = pdf.getImageProperties(imgDataHeaderGeneral);
            
            // Validate dimensions before adding image
            if (imgPropsHeaderGeneral.width === 0 || imgPropsHeaderGeneral.height === 0) {
                console.error("Error: Header/General section captured with zero dimensions. Skipping this section.");
            } else {
                const imgHeightHeaderGeneral = (imgPropsHeaderGeneral.height * contentWidth) / imgPropsHeaderGeneral.width;
                pdf.addImage(imgDataHeaderGeneral, 'PNG', margin, yOffset, contentWidth, imgHeightHeaderGeneral);
                yOffset += imgHeightHeaderGeneral + margin;
            }

            // 2. Secci√≥n de Bombas
            const preparedBombas = prepareElementForCapture(document.getElementById('seccionBombas'));
            document.body.appendChild(preparedBombas);
            const canvasBombas = await html2canvas(preparedBombas, { scale: 2, useCORS: true, allowTaint: true, logging: false });
            document.body.removeChild(preparedBombas);

            const imgDataBombas = canvasBombas.toDataURL('image/png');
            const imgPropsBombas = pdf.getImageProperties(imgDataBombas);

            // Validate dimensions before adding image
            if (imgPropsBombas.width === 0 || imgPropsBombas.height === 0) {
                console.error("Error: Bombas section captured with zero dimensions. Skipping this section.");
            } else {
                const imgHeightBombas = (imgPropsBombas.height * contentWidth) / imgPropsBombas.width;

                if (yOffset + imgHeightBombas > pageHeight - margin) {
                    pdf.addPage();
                    yOffset = margin;
                }
                pdf.addImage(imgDataBombas, 'PNG', margin, yOffset, contentWidth, imgHeightBombas);
                yOffset += imgHeightBombas + margin;
            }

            // 3. Secci√≥n de Hidrantes
            const preparedHidrantes = prepareElementForCapture(document.getElementById('seccionHidrantes'));
            document.body.appendChild(preparedHidrantes);
            const canvasHidrantes = await html2canvas(preparedHidrantes, { scale: 2, useCORS: true, allowTaint: true, logging: false });
            document.body.removeChild(preparedHidrantes);

            const imgDataHidrantes = canvasHidrantes.toDataURL('image/png');
            const imgPropsHidrantes = pdf.getImageProperties(imgDataHidrantes);

            // Validate dimensions before adding image
            if (imgPropsHidrantes.width === 0 || imgPropsHidrantes.height === 0) {
                console.error("Error: Hidrantes section captured with zero dimensions. Skipping this section.");
            } else {
                const imgHeightHidrantes = (imgPropsHidrantes.height * contentWidth) / imgPropsHidrantes.width;

                if (yOffset + imgHeightHidrantes > pageHeight - margin) {
                    pdf.addPage();
                    yOffset = margin;
                }
                pdf.addImage(imgDataHidrantes, 'PNG', margin, yOffset, contentWidth, imgHeightHidrantes);
                yOffset += imgHeightHidrantes + margin;
            }

            // 4. Secci√≥n de Evidencia Fotogr√°fica
            pdf.addPage();
            yOffset = margin;
            pdf.setFontSize(14);
            pdf.text("Evidencia Fotogr√°fica", margin, yOffset + 5);
            yOffset += 15;

            const photoContainer = document.getElementById('photo-upload-container');
            const photoGroups = photoContainer.querySelectorAll('.input-group');

            const photoColWidth = (contentWidth - 10) / 2; // Ancho para 2 columnas con 10mm de espacio entre ellas
            const photoMaxCellHeight = 120; // Altura m√°xima para cada celda de foto (ajustable)
            let currentColumn = 0;
            let currentPhotoYOffset = yOffset;

            for (const group of photoGroups) {
                const imgPreview = group.querySelector('.photo-preview');
                const locationInput = group.querySelector('.photo-location');

                if (imgPreview && imgPreview.src && imgPreview.src !== window.location.href && !imgPreview.classList.contains('hidden')) {
                    const imgData = imgPreview.src;
                    const imgProps = pdf.getImageProperties(imgData);
                    const aspectRatio = imgProps.width / imgProps.height;
                    
                    let imgPdfWidth = photoColWidth;
                    let imgPdfHeight = imgPdfWidth / aspectRatio;

                    // Escalar la imagen para que quepa dentro de la altura m√°xima de la celda
                    if (imgPdfHeight > photoMaxCellHeight - 20) { // 20mm para el texto de la ubicaci√≥n y padding
                        imgPdfHeight = photoMaxCellHeight - 20;
                        imgPdfWidth = imgPdfHeight * aspectRatio;
                    }

                    let xPos = margin + (currentColumn * (photoColWidth + 10)); // 10mm de gap

                    // Si la imagen actual no cabe en la fila actual, o si es la 3ra columna, avanzar a la siguiente fila
                    if (currentColumn >= 2) {
                        currentColumn = 0;
                        currentPhotoYOffset += photoMaxCellHeight; // Mover a la siguiente fila
                    }

                    // Si no hay espacio en la p√°gina para la siguiente fila, a√±adir una nueva p√°gina
                    if (currentPhotoYOffset + photoMaxCellHeight > pageHeight - margin) {
                        pdf.addPage();
                        currentPhotoYOffset = margin;
                        yOffset = margin; // Reset yOffset para la secci√≥n
                        pdf.setFontSize(14);
                        pdf.text("Evidencia Fotogr√°fica (continuaci√≥n)", margin, yOffset + 5);
                        currentPhotoYOffset += 15;
                    }

                    // Centrar imagen en su celda
                    pdf.addImage(imgData, 'PNG', xPos + (photoColWidth - imgPdfWidth) / 2, currentPhotoYOffset + 5, imgPdfWidth, imgPdfHeight); // +5 para padding superior

                    // A√±adir texto de ubicaci√≥n de la foto
                    if (locationInput && locationInput.value) {
                        pdf.setFontSize(8); // Tama√±o de fuente m√°s peque√±o para ubicaci√≥n
                        const textLines = pdf.splitTextToSize(`Ubicaci√≥n: ${locationInput.value}`, photoColWidth - 4); // -4 para padding
                        pdf.text(textLines, xPos + 2, currentPhotoYOffset + imgPdfHeight + 10); // +10 para espacio despu√©s de imagen
                    }
                    
                    currentColumn++;
                }
            }
            yOffset = currentPhotoYOffset + photoMaxCellHeight + margin; // Actualizar yOffset general para la siguiente secci√≥n

            // 5. Secci√≥n de Firmas, Observaciones y Footer
            pdf.addPage();
            yOffset = margin;

            const firmasObsFooter = document.createElement('div');
            firmasObsFooter.appendChild(document.getElementById('seccionFirmas').cloneNode(true));
            firmasObsFooter.appendChild(document.getElementById('seccionObservaciones').cloneNode(true));
            firmasObsFooter.appendChild(document.querySelector('.footer').cloneNode(true));
            
            const preparedFirmasObsFooter = prepareElementForCapture(firmasObsFooter);
            document.body.appendChild(preparedFirmasObsFooter);

            const canvasFirmasObsFooter = await html2canvas(preparedFirmasObsFooter, { scale: 2, useCORS: true, allowTaint: true, logging: false });
            document.body.removeChild(preparedFirmasObsFooter);

            const imgDataFirmasObsFooter = canvasFirmasObsFooter.toDataURL('image/png');
            const imgPropsFirmasObsFooter = pdf.getImageProperties(imgDataFirmasObsFooter);
            
            // Validate dimensions before adding image
            if (imgPropsFirmasObsFooter.width === 0 || imgPropsFirmasObsFooter.height === 0) {
                console.error("Error: Firmas/Observaciones/Footer section captured with zero dimensions. Skipping this section.");
            } else {
                const imgHeightFirmasObsFooter = (imgPropsFirmasObsFooter.height * contentWidth) / imgPropsFirmasObsFooter.width;
                pdf.addImage(imgDataFirmasObsFooter, 'PNG', margin, yOffset, contentWidth, imgHeightFirmasObsFooter);
            }

            pdf.save("RCI_reporte_servicio.pdf");

        } catch (error) {
            console.error("Error al generar el PDF:", error);
            alert("Hubo un error al generar el PDF. Por favor, revisa la consola para m√°s detalles.");
        } finally {
            // Asegurarse de restaurar el color de fondo del body incluso si hay un error
            document.body.style.backgroundColor = '';
        }
      });

      // Enviar correo (sin adjuntos, por limitaci√≥n de mailto:)
      document.getElementById("mailBtn").addEventListener("click", () => {
        const lugar = document.getElementById("lugar").value;
        const tecnico = document.getElementById("tecnico").value;
        const fecha = document.getElementById("fecha").value;
        const observaciones = document.getElementById("observaciones").value;

        const asunto = `Reporte T√©cnico RCI - ${fecha} - ${lugar}`;
        const cuerpo = `Estimado(a),\n\nAdjunto el reporte t√©cnico de servicios.\n\nDatos del Reporte:\nLugar: ${lugar}\nT√©cnico: ${tecnico}\nFecha: ${fecha}\n\nObservaciones: ${observaciones}\n\nSaludos cordiales,\nEquipo RCI Sistemas Contra Incendio`;

        window.location.href = `mailto:rciadan2024@gmail.com?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
      });

      // Funci√≥n para recopilar todos los datos del formulario como texto
      function gatherFormDataAsText() {
          let reportText = "--- Reporte T√©cnico de Servicios RCI ---\n\n";

          // Datos Generales
          reportText += "üîß DATOS GENERALES:\n";
          reportText += `Lugar: ${document.getElementById('lugar').value || 'N/A'}\n`;
          reportText += `Fecha: ${document.getElementById('fecha').value || 'N/A'}\n\n`;

          // Bombas
          reportText += "--- Informaci√≥n de Bombas ---\n\n";
          reportText += "üßØ BOMBA JOCKEY:\n";
          document.querySelectorAll('#seccionBombas .grid:nth-of-type(1) .input-group').forEach(group => {
              const label = group.querySelector('label').textContent;
              const input = group.querySelector('input');
              if (input) reportText += `${label}: ${input.value || 'N/A'}\n`;
          });
          reportText += "\n‚ö° BOMBA EL√âCTRICA:\n";
          document.querySelectorAll('#seccionBombas .grid:nth-of-type(2) .input-group').forEach(group => {
              const label = group.querySelector('label').textContent;
              const input = group.querySelector('input');
              if (input) reportText += `${label}: ${input.value || 'N/A'}\n`;
          });
          reportText += "\nüî• BOMBA DI√âSEL:\n";
          document.querySelectorAll('#seccionBombas .grid:nth-of-type(3) .input-group').forEach(group => {
              const label = group.querySelector('label').textContent;
              if (label.includes('Nivel Diesel')) {
                  const selectedRadio = group.querySelector('input[name="nivelDiesel"]:checked');
                  reportText += `${label}: ${selectedRadio ? selectedRadio.value : 'N/A'}\n`;
              } else {
                  const input = group.querySelector('input:not([type="checkbox"]):not([type="radio"])');
                  const checkbox = group.querySelector('input[type="checkbox"]');
                  if (input) {
                      let value = input.value || 'N/A';
                      if (checkbox) value += (checkbox.checked ? ' (OK)' : ' (NO OK)');
                      reportText += `${label}: ${value}\n`;
                  }
              }
          });
          reportText += "\n";

          // Hidrantes
          reportText += "--- Inspecci√≥n de Hidrantes ---\n\n";
          document.querySelectorAll('#hidrantes-container .hidrante-item').forEach((item, index) => {
              const commentsTextarea = item.querySelector('textarea');
              const check = item.querySelector('.hidrante-check');

              reportText += `üíß Hidrante N¬∞ ${index + 1}: `;
              reportText += check && check.checked ? ' (OK)\n' : ' (NO OK)\n';
              reportText += `Comentarios: ${commentsTextarea ? commentsTextarea.value || 'Sin comentarios' : 'N/A'}\n\n`;
          });

          // Fotos (solo ubicaciones, no las im√°genes en s√≠)
          reportText += "--- Evidencia Fotogr√°fica (Ubicaciones) ---\n\n";
          document.querySelectorAll('#photo-upload-container .input-group').forEach((group, index) => {
              const locationInput = group.querySelector('.photo-location');
              const imgPreview = group.querySelector('.photo-preview');
              if (imgPreview && imgPreview.src && imgPreview.src !== window.location.href && !imgPreview.classList.contains('hidden')) {
                  reportText += `Foto ${index + 1}: ${locationInput ? locationInput.value || 'Sin ubicaci√≥n' : 'Sin ubicaci√≥n'}\n`;
              }
          });
          if (document.querySelectorAll('#photo-upload-container .input-group .photo-preview:not(.hidden)').length === 0) {
              reportText += "No se adjuntaron fotos.\n";
          }
          reportText += "\n";

          // Firmas
          reportText += "--- Firmas ---\n";
          const nombreTecnico = document.getElementById('tecnico').value;
          const nombreSupervisor = document.getElementById('atiende').value;
          reportText += `T√©cnico: ${nombreTecnico || 'Sin firmar'}\n`;
          reportText += `Supervisor: ${nombreSupervisor || 'Sin firmar'}\n\n`;
          
          const autoFillNamesCheckbox = document.getElementById('autoFillNames');
          if (autoFillNamesCheckbox) {
              reportText += `Se queda todo en autom√°tico: ${autoFillNamesCheckbox.checked ? 'S√≠' : 'No'}\n\n`;
          }

          // Observaciones
          reportText += "--- Observaciones ---\n";
          reportText += `${document.getElementById('observaciones').value || 'Sin observaciones'}\n\n`;

          reportText += "------------------------------------";
          return reportText;
      }

      // Compartir PDF por WhatsApp
      document.getElementById("whatsappBtn").addEventListener("click", () => {
        const fullReportText = gatherFormDataAsText();
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(fullReportText)}`;
        window.open(whatsappUrl, '_blank');
      });

    </script>

    <!-- üìå Pie de p√°gina institucional -->
    <div class="footer">
      <p class="text-sm">RCI M√©xico ‚Äî Certificados NFPA</p>
    </div>
  </div>
</body>
</html>

