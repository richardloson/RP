<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RCI - Reporte T√©cnico de Servicios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f1f5f9;
    }
    .header {
      background-color: #1e40af;
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: 10px 10px 0 0;
    }
    .footer {
      background-color: #1e3a8a;
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: 40px;
      border-radius: 0 0 10px 10px;
    }
    .section-title {
      border-left: 4px solid #1d4ed8;
      padding-left: 12px;
      margin-bottom: 20px;
      font-weight: bold;
      font-size: 1.2rem;
      color: #1e3a8a;
    }
    .input-group {
      margin-bottom: 16px;
    }
    label {
      font-weight: 600;
      color: #1e3a8a;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"], /* A√±adido para el estilo de inputs num√©ricos */
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background-color: white;
    }
    .btn {
      padding: 12px 24px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .btn:hover {
      background-color: #1d4ed8;
    }
    /* Estilo para el canvas de firma */
    canvas {
        border:1px solid #ccc;
        border-radius:8px;
        background-color: #f9fafb; /* Ligeramente gris para que se vea el borde */
        touch-action: none; /* Previene el scroll en m√≥viles al dibujar */
    }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto mt-6 shadow-xl bg-white rounded-xl overflow-hidden" id="reporteContent">

    <div class="header">
      <h1 class="text-3xl font-bold">RCI Sistemas Contra Incendio</h1>
    </div>

    <div class="px-6 py-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div>
          <label for="lugar">üìç Lugar</label>
          <div class="flex gap-2 mt-1">
            <input type="text" id="lugar" class="border rounded px-3 py-2 w-full" placeholder="Ubicaci√≥n" inputmode="text">
            <button onclick="obtenerUbicacion()" class="btn">Ubicaci√≥n GPS</button>
          </div>
        </div>
        <div>
          <label for="tecnico">üë∑ T√©cnico</label>
          <input type="text" id="tecnico" class="border rounded px-3 py-2 w-full mt-1" placeholder="Nombre">
        </div>
        <div>
          <label for="atiende">üë§ Atiende</label>
          <input type="text" id="atiende" class="border rounded px-3 py-2 w-full mt-1" placeholder="Responsable en sitio">
        </div>
        <div>
          <label for="fecha">üìÖ Fecha</label>
          <input type="date" id="fecha" class="border rounded px-3 py-2 w-full mt-1">
        </div>
      </div>

      <div class="section-title">Bomba Jockey</div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="input-group"><label>V. Entrada L1-L2</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>V. Entrada L1-L3</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>V. Entrada L2-L3</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Amperaje L1</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Amperaje L2</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Amperaje L3</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Descarga PSI</label><input type="number" inputmode="numeric"></div>
      </div>

      <div class="section-title mt-8">Bomba El√©ctrica</div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="input-group"><label>V. Entrada L1-L2</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>V. Entrada L1-L3</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>V. Entrada L2-L3</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Amperaje L1</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Amperaje L2</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Amperaje L3</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Descarga PSI</label><input type="number" inputmode="numeric"></div>
      </div>

      <div class="section-title mt-8">Bomba Di√©sel</div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="input-group"><label>Nivel Agua/Aceite</label><input type="text" inputmode="text"></div>
        <div class="input-group"><label>Diesel (+¬æ / -¬æ)</label><input type="text" inputmode="text"></div>
        <div class="input-group"><label>Presi√≥n Aceite PSI</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Temperatura Inicial ¬∞C</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Temperatura Final ¬∞C</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Horas Inicial</label><input type="number" inputmode="numeric"></div>
        <div class="input-group"><label>Horas Final</label><input type="number" inputmode="numeric"></div>
      </div>
      <div class="section-title mt-10">Evidencia Fotogr√°fica</div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label>Foto 1</label>
          <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label>Foto 2</label>
          <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label>Foto 3</label>
          <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label>Foto 4</label>
          <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label>Foto 5</label>
          <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label>Foto 6</label>
          <input type="file" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
      </div>
      <div class="section-title mt-10">Firmas</div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">

        <div>
          <label>Firma del T√©cnico</label>
          <canvas id="firmaTecnico" width="300" height="150"></canvas>
          <button class="btn btn-clear-signature" onclick="clearSignature('firmaTecnico')">Limpiar</button>
          <input type="text" id="nombreTecnicoFirma" class="border rounded px-3 py-2 w-full mt-2" placeholder="Nombre del t√©cnico">
        </div>

        <div>
          <label>Firma del Supervisor</label>
          <canvas id="firmaSupervisor" width="300" height="150"></canvas>
          <button class="btn btn-clear-signature" onclick="clearSignature('firmaSupervisor')">Limpiar</button>
          <input type="text" id="nombreSupervisorFirma" class="border rounded px-3 py-2 w-full mt-2" placeholder="Nombre del supervisor">
        </div>
      </div>

      <div class="section-title mt-10">Observaciones</div>
      <textarea id="observaciones" class="w-full h-24 p-3 border rounded mb-4" placeholder="Observaciones generales..."></textarea>

      <div class="flex flex-col sm:flex-row gap-4 mt-4">
        <button id="pdfBtn" class="btn w-full sm:w-auto">Exportar a PDF</button>
        <button id="mailBtn" class="btn w-full sm:w-auto bg-green-600 hover:bg-green-700">Enviar por correo</button>
      </div>
    </div> <script>
      const { jsPDF } = window.jspdf;

      // Funci√≥n para inicializar canvas de firma
      function inicializarCanvasFirma(idCanvas) {
        const canvas = document.getElementById(idCanvas);
        const ctx = canvas.getContext("2d");
        let dibujando = false;

        // Establecer el color de fondo del canvas (blanco) para html2canvas
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        canvas.addEventListener("mousedown", (e) => {
          dibujando = true;
          const rect = canvas.getBoundingClientRect();
          ctx.beginPath();
          ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });
        canvas.addEventListener("mouseup", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("mouseout", () => { // Detener dibujo si el cursor sale del canvas
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("mousemove", e => {
          if (!dibujando) return;
          const rect = canvas.getBoundingClientRect();
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.strokeStyle = "#111827";
          ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
          ctx.stroke();
        });

        // Para dispositivos t√°ctiles
        canvas.addEventListener("touchstart", (e) => {
          dibujando = true;
          e.preventDefault(); // Evita el scroll
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.beginPath();
          ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });
        canvas.addEventListener("touchend", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("touchcancel", () => {
          dibujando = false;
          ctx.closePath();
        });
        canvas.addEventListener("touchmove", (e) => {
          if (!dibujando) return;
          e.preventDefault(); // Evita el scroll
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.strokeStyle = "#111827";
          ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          ctx.stroke();
        });
      }

      function clearSignature(idCanvas) {
        const canvas = document.getElementById(idCanvas);
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Volver a dibujar el fondo blanco
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      inicializarCanvasFirma("firmaTecnico");
      inicializarCanvasFirma("firmaSupervisor");


      // Obtener ubicaci√≥n GPS (no un mapa interactivo)
      function obtenerUbicacion() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const lat = pos.coords.latitude.toFixed(5);
              const lon = pos.coords.longitude.toFixed(5);
              document.getElementById("lugar").value = `Lat: ${lat}, Lon: ${lon}`;
              alert("Ubicaci√≥n obtenida por GPS.");
            },
            err => {
              alert("No se pudo obtener la ubicaci√≥n. Activa permisos de GPS y aseg√∫rate de tener conexi√≥n.");
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        } else {
          alert("Tu navegador no permite geolocalizaci√≥n.");
        }
      }

      // Exportar PDF
      document.getElementById("pdfBtn").addEventListener("click", () => {
        const inputElements = document.querySelectorAll('input, textarea');
        inputElements.forEach(input => {
            input.style.border = 'none'; // Eliminar bordes para el PDF
            input.style.backgroundColor = 'transparent'; // Eliminar fondo
        });

        const buttons = document.querySelectorAll('.btn');
        buttons.forEach(button => {
            button.style.display = 'none'; // Ocultar botones
        });

        // Asegurarse de que el color de fondo del body sea blanco para la captura
        document.body.style.backgroundColor = '#ffffff';

        html2canvas(document.getElementById("reporteContent"), {
            scale: 2, // Aumenta la resoluci√≥n para mejor calidad del PDF
            useCORS: true, // Importante si hay im√°genes de diferentes or√≠genes (como firmas)
            allowTaint: true, // Permitir contenido "tainted" (menos seguro pero a veces necesario)
            logging: true, // Habilita el log para depuraci√≥n
            scrollX: 0, // Asegura que se captura desde el inicio del scroll
            scrollY: 0,
            windowWidth: document.documentElement.offsetWidth, // Captura el ancho completo de la ventana
            windowHeight: document.documentElement.offsetHeight
        }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p", "mm", "a4");
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgProps = pdf.getImageProperties(imgData);

            // Calcular el alto de la imagen en el PDF manteniendo el aspect ratio
            const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

            let position = 0; // Posici√≥n vertical en el PDF

            // Si la altura de la imagen es mayor que la altura de una p√°gina, se divide en varias p√°ginas
            if (pdfHeight > pageHeight) {
                let currentPage = 1;
                let remainingHeight = pdfHeight;

                while (remainingHeight > 0) {
                    pdf.addImage(imgData, "PNG", 0, position, pageWidth, pdfHeight);
                    remainingHeight -= pageHeight;
                    position -= pageHeight; // Mueve la posici√≥n para la siguiente "ventana" de la imagen
                    if (remainingHeight > 0) {
                        pdf.addPage();
                        currentPage++;
                    }
                }
            } else {
                pdf.addImage(imgData, "PNG", 0, 0, pageWidth, pdfHeight);
            }

            pdf.save("RCI_reporte_servicio.pdf");

            // Restaurar estilos despu√©s de la exportaci√≥n
            inputElements.forEach(input => {
                input.style.border = ''; // Restaurar borde
                input.style.backgroundColor = ''; // Restaurar fondo
            });
            buttons.forEach(button => {
                button.style.display = ''; // Restaurar visibilidad
            });
            document.body.style.backgroundColor = ''; // Restaurar color de fondo del body

        }).catch(error => {
            console.error("Error al generar PDF:", error);
            alert("Hubo un error al generar el PDF. Por favor, revisa la consola para m√°s detalles.");

            // Asegurarse de restaurar los estilos incluso si hay un error
            const inputElements = document.querySelectorAll('input, textarea');
            inputElements.forEach(input => {
                input.style.border = '';
                input.style.backgroundColor = '';
            });
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.style.display = '';
            });
            document.body.style.backgroundColor = '';
        });
      });

      // Enviar correo (sin adjuntos, por limitaci√≥n de mailto:)
      document.getElementById("mailBtn").addEventListener("click", () => {
        const lugar = document.getElementById("lugar").value;
        const tecnico = document.getElementById("tecnico").value;
        const fecha = document.getElementById("fecha").value;
        const observaciones = document.getElementById("observaciones").value; // Capturar observaciones

        const asunto = `Reporte T√©cnico RCI - ${fecha} - ${lugar}`;
        const cuerpo = `Estimado(a),\n\nAdjunto el reporte t√©cnico de servicios.\n\nDatos del Reporte:\nLugar: ${lugar}\nT√©cnico: ${tecnico}\nFecha: ${fecha}\n\nObservaciones: ${observaciones}\n\nSaludos cordiales,\nEquipo RCI Sistemas Contra Incendio`;

        // El cliente de correo se abrir√° con el asunto y cuerpo prellenados.
        // Los adjuntos NO se pueden enviar directamente con mailto:.
        window.location.href = `mailto:rciadan2024@gmail.com?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
      });
    </script>

    <div class="footer">
      <p class="text-sm">RCI M√©xico ‚Äî Certificados NFPA</p>
    </div>
  </div>
</body>
</html>
